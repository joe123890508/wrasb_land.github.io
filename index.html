<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>土地盤點系統</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 0;
    }

    .form-container {
      width: 100%;
      border: 1px solid #ccc;
      padding: 1em;
      margin: 1em auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    /* 地圖 RWD */
    #container {
      height: 40vh; /* 40% 螢幕高度 */
      min-height: 250px;
      margin: 10px 0;
    }
    #map {
      height: 100%;
    }
    /* 手機 (長寬比小於 1 → 高 > 寬) */
    @media (max-aspect-ratio: 1/1) {
      #container {
        height: 20vh;   /* 改成佔 25% 高度 */
        min-height: 180px;
      }
    }
    /* 圖片區塊 RWD */
    .image-wrapper {
      width: 100%;
      max-width: 100%;
      aspect-ratio: 16/9;
      margin: 10px 0;
    }
    #preview-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }
    #preview-image.visible {
      display: block;
    }

    /* 小螢幕優化 */
    @media (max-width: 576px) {
      select, input, textarea, button {
        width: 100% !important;
      }
    }

    /* === 修正 Leaflet Basemap Control RWD 顯示 === */
.leaflet-control.basemaps {
  background: rgba(255, 255, 255, 0.9);
  padding: 4px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.leaflet-control.basemaps .basemap {
  cursor: pointer;
  border: 2px solid transparent;
  border-radius: 4px;
  overflow: hidden;
}

.leaflet-control.basemaps .basemap img {
  display: block;
  width: 60px;
  height: 60px;
  object-fit: cover;
}

.leaflet-control.basemaps .basemap.active {
  border-color: #007bff;
}

.leaflet-control.basemaps .basemap.alt {
  border-color: #6c757d;
}

/* 小螢幕 (手機) 底圖控制器改水平排列 */
@media (max-width: 576px) {
  .leaflet-control.basemaps {
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
  }
  .leaflet-control.basemaps .basemap img {
    width: 50px;
    height: 50px;
  }
}
  </style>
</head>
<body>

<div class="container">
  <h1 class="text-center my-3">土地盤點系統</h1>

  <div class="form-container" id="form-content">
    <div class="row">
      <div class="col-md-4 col-12">
        <label for="county">縣市：</label>
        <select id="county_list" class="form-select" onchange="change_county(this.value)"></select>
      </div>
      <div class="col-md-4 col-12">
        <label for="town">行政區：</label>
        <select id="town_list" class="form-select" onchange="change_town(this.value)"></select>
      </div>
      <div class="col-md-4 col-12">
        <label for="dist">地段：</label>
        <select id="village_list" class="form-select" onchange="change_village(this.value)"></select>
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-md-6 col-12">
        <input type="text" id="pmno" name="pmno" class="form-control" placeholder="pmno" />
      </div>
      <div class="col-md-6 col-12">
        <input type="text" id="pcno" name="pcno" class="form-control" placeholder="pcno" />
      </div>
    </div>

    <div class="mt-3">
      <button type="button" id="find_land" class="btn btn-primary w-100">確認盤點內容</button>
    </div>

    <div class="mt-3">
      <label for="message">備註：</label>
      <textarea id="message" name="message" rows="2" class="form-control"></textarea>
    </div>

    <div class="mt-2">
      <button type="button" id="get_gps" class="btn btn-secondary w-100">取得 GPS 位置</button>
    </div>

    <div id="container" class="mt-3">
      <div id="map">
        <div class="modal fade" id="featureModal" tabindex="-1" role="dialog">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title text-primary" id="feature-title"></h4>
                <button class="close" type="button" data-bs-dismiss="modal">×</button>
              </div>
              <div class="modal-body" id="feature-info"></div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" id="google_map">在Google地圖開啟</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3" id="image_top">
      <label for="image">上傳圖片：</label>
      <input type="file" id="image" class="form-control" accept="image/*" />
    </div>

    <div class="image-wrapper">
      <img id="preview-image" src="" alt="圖片預覽" />
    </div>
  </div>

  <div class="text-center my-4">
    <button class="btn btn-success" onclick="generatePDF()">匯出為 PDF</button>
  </div>
</div>

<script>
  var map = L.map('map', {center: [22.689,120.436], zoom: 15, zoomControl: true});
  L.control.scale({position: 'bottomleft'}).addTo(map);

  var basemaps = [
    L.tileLayer('https://wmts.nlsc.gov.tw/wmts/{id}/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
    maxZoom: 20,
    id: 'EMAP',
    label: '測試一' }),
    L.tileLayer('https://wmts.nlsc.gov.tw/wmts/{id}/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
    maxZoom: 20,
    id: 'PHOTO2',
    label: '測試二' }),
    L.tileLayer('https://wmts.nlsc.gov.tw/wmts/{id}/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
      maxZoom: 20,
      id: 'LUIMAP',
      label: '測試三' })
  ];

  L.Control.Basemaps=L.Control.extend({_map:null,includes:L.Evented?L.Evented.prototype:L.Mixin.Event,options:{position:"bottomright",tileX:0,tileY:0,tileZ:0,layers:[]},basemap:null,onAdd:function(e){this._map=e;var t=L.DomUtil.create("div","basemaps leaflet-control closed");return L.DomEvent.disableClickPropagation(t),L.Browser.touch||L.DomEvent.disableScrollPropagation(t),this.options.basemaps.forEach(function(s,o){var a,i="basemap";if(0===o?(this.basemap=s,this._map.addLayer(s),i+=" active"):1===o&&(i+=" alt"),s.options.iconURL)a=s.options.iconURL;else{var l={x:this.options.tileX,y:this.options.tileY};if(a=L.Util.template(s._url,L.extend({s:s._getSubdomain(l),x:l.x,y:s.options.tms?s._globalTileRange.max.y-l.y:l.y,z:this.options.tileZ},s.options)),s instanceof L.TileLayer.WMS){s._map=e;var n=s.options.crs||e.options.crs,r=L.extend({},s.wmsParams),m=parseFloat(r.version);r[m>=1.3?"crs":"srs"]=n.code;var p=L.point(l);p.z=this.options.tileZ;var c=s._tileCoordsToBounds(p),d=n.project(c.getNorthWest()),h=n.project(c.getSouthEast()),v=(m>=1.3&&n===L.CRS.EPSG4326?[h.y,d.x,d.y,h.x]:[d.x,h.y,h.x,d.y]).join(",");a+=L.Util.getParamString(r,a,s.options.uppercase)+(s.options.uppercase?"&BBOX=":"&bbox=")+v}}var b=L.DomUtil.create("div",i,t),u=L.DomUtil.create("img",null,b);u.src=a,s.options&&s.options.label&&(u.title=s.options.label),L.DomEvent.on(b,"click",function(){if(this.options.basemaps.length>2&&L.Browser.mobile&&L.DomUtil.hasClass(t,"closed"))L.DomUtil.removeClass(t,"closed");else if(s!=this.basemap){e.removeLayer(this.basemap),e.addLayer(s),s.bringToBack(),e.fire("baselayerchange",s),this.basemap=s,L.DomUtil.removeClass(t.getElementsByClassName("basemap active")[0],"active"),L.DomUtil.addClass(b,"active");var a=(o+1)%this.options.basemaps.length;L.DomUtil.removeClass(t.getElementsByClassName("basemap alt")[0],"alt"),L.DomUtil.addClass(t.getElementsByClassName("basemap")[a],"alt"),L.DomUtil.addClass(t,"closed")}},this)},this),this.options.basemaps.length>2&&!L.Browser.mobile&&(L.DomEvent.on(t,"mouseenter",function(){L.DomUtil.removeClass(t,"closed")},this),L.DomEvent.on(t,"mouseleave",function(){L.DomUtil.addClass(t,"closed")},this)),this._container=t,this._container}}),L.control.basemaps=function(e){return new L.Control.Basemaps(e)};

  map.addControl(L.control.basemaps({
    basemaps: basemaps,
    tileX: 854,
    tileY: 444,
    tileZ: 10
  }));

  const imageInput = document.getElementById('image');
  const previewImage = document.getElementById('preview-image');

  imageInput.addEventListener('change', function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        previewImage.src = e.target.result;
        previewImage.classList.add('visible');
      };
      reader.readAsDataURL(file);
    } else {
      previewImage.src = '';
      previewImage.classList.remove('visible');
    }
  });

  async function generatePDF() {
    const original = document.getElementById('form-content');
    const clone = original.cloneNode(true);
    // 移除 clone 中的「確認盤點內容」按鈕
    const findLandBtn = clone.querySelector('#find_land');
    if (findLandBtn) {
      findLandBtn.remove();
    }
    // 移除 get_gps 按鈕
    const gpsBtn = clone.querySelector("#get_gps");
    if (gpsBtn) {
      gpsBtn.remove();
    }
    // 移除圖片路徑
    const img_path = clone.querySelector("#image_top");
    if (img_path) {
      img_path.remove();
    }

    // 從原始 map 元素截圖，不要用 clone 裡的
    const mapElementOriginal = document.querySelector('#map');
    const mapElementClone = clone.querySelector('#map');

    if (mapElementOriginal && mapElementClone) {
      try {
        const canvas = await html2canvas(mapElementOriginal, {
          useCORS: true,
          scale: 2,
          scrollX: 0,
          scrollY: -window.scrollY,
          windowWidth: document.documentElement.clientWidth,
          windowHeight: document.documentElement.clientHeight,
        });
        const imgDataUrl = canvas.toDataURL('image/png');
        const img = document.createElement('img');
        img.src = imgDataUrl;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'fill';
        mapElementClone.parentNode.replaceChild(img, mapElementClone);
      } catch (error) {
        console.error('地圖截圖失敗:', error);
      }
    }

    // 把原始頁面上的所有輸入欄位轉成純文字段落（保留選取值）
    const originalElements = Array.from(original.querySelectorAll('input, textarea, select'));
    const cloneElements = Array.from(clone.querySelectorAll('input, textarea, select'));

    cloneElements.forEach(cloneEl => {
      const name = cloneEl.getAttribute('name') || cloneEl.getAttribute('id');
      const originalEl = originalElements.find(el =>
        (el.getAttribute('name') || el.getAttribute('id')) === name
      );
      if (!originalEl) return;
      const label = cloneEl.previousElementSibling;
      const labelText = label ? label.textContent.trim() : '';
      const p = document.createElement('p');
      let valueText = '';
      if (originalEl.tagName.toLowerCase() === 'select') {
        valueText = originalEl.options[originalEl.selectedIndex]?.text || '';
      } else {
        valueText = originalEl.value;
      }
      p.textContent = `${labelText} ${valueText}`;
      p.style.margin = '0.2em 0';
      if (label) label.remove();
      cloneEl.replaceWith(p);
    });
    // 圖片處理 (form中的預覽圖片)
    const imgPreview = clone.querySelector('#preview-image');
    if (imgPreview) {
      if (!imgPreview.src) {
        imgPreview.remove();
      } else {
        imgPreview.style.width = '100%';
        imgPreview.style.height = '100%';
        imgPreview.style.objectFit = 'fill';
        imgPreview.classList.add('visible');
      }
    }
    // 移除空白節點，避免多餘空白
    clone.querySelectorAll('p, div').forEach(el => {
      if (!el.textContent.trim() && el.querySelectorAll('*').length === 0) {
        el.remove();
      }
    });
    // 等圖片載入完成後匯出 PDF
    const waitForImage = new Promise(resolve => {
      if (!imgPreview || (imgPreview.complete && imgPreview.naturalHeight !== 0)) {
        resolve();
      } else {
        imgPreview.onload = () => resolve();
        imgPreview.onerror = () => resolve();
      }
    });
    await waitForImage;
    const opt = {
      margin: 10,
      filename: county + town + village + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        scrollY: 0,
      },
      jsPDF: {
        unit: 'mm',
        format: 'a4',
        orientation: 'portrait',
      },
    };
    html2pdf().set(opt).from(clone).save();
  }


google_map_url = 'https://www.google.com/maps/search/?api=1&query='
var pois = L.geoJson(null, {
  style: function (feature) {
    return {
      weight: 1.5, // 線的寬度（預設為 3）
    };
  },
  pointToLayer: (feature, latlng) => {
    return L.marker(latlng);},
  onEachFeature: (feature, layer) => {
      layer.on("click", () => {
          table_content = '<table border="1">'
          for (let key in feature.properties) {
            table_content = table_content + '<tr><th>' + key + '</th><td>' + feature.properties[key] + '</td></tr>'
          };
          table_content = table_content + '</table>'
          document.getElementById("feature-info").innerHTML = table_content
          document.getElementById("feature-title").innerHTML = feature.properties['LANDNO']
          $('#featureModal').modal('show')
          const center = layer.getBounds().getCenter()
          const lat = center.lat
          const lng = center.lng
          url = google_map_url + lat + ',' +lng
          $('#google_map').off().on('click', function () {
            window.open(url);
          });
          $('.close').click(function() {
            $('#featureModal').modal('hide');
          });
        });
  }
})
  let global_json;
  fetch ("https://joe123890508.github.io/test.geojson")
    .then(response => response.json())
    .then(json => {
      data=json.features;
      pois.addData(data);
      map.addLayer(pois);
      var county_list=document.getElementById("county_list");
      town_list.innerHTML="<option value>請選擇鄉鎮</option>";
      village_list.innerHTML="<option value>請選擇地段</option>";
      global_json = json
      let inner="<option value>請選擇縣市</option>";
        let inner_list = [];
        for (let i=0;i<json['features'].length;i++){
          county = json['features'][i].properties.RCOUNTY;
          if (!inner_list.includes(county)){
            inner=inner+'<option value='+county+'>'+county+'</option>';
            inner_list.push(county);
          }
        };
      county_list.innerHTML=inner;
    });

  function change_county(_county) {
    village_list.innerHTML="<option value>請選擇鄉鎮</option>";
    var inner="<option value>請選擇地段</option>";
    //console.log(county);
    let inner_list = []
    for (let i=0;i<global_json['features'].length;i++){
      if (_county === global_json['features'][i].properties.RCOUNTY){
        town = global_json['features'][i].properties.RTOWN;
        if (!inner_list.includes(town)){
            inner=inner+'<option value='+town+'>'+town+'</option>';
            inner_list.push(town);
        };
      };
    };
    town_list.innerHTML=inner;
  };

  function change_town(_town) {
    var inner="<option value>請選擇地段</option>";
    //console.log(county);
    let inner_list = []
    for (let i=0;i<global_json['features'].length;i++){
      if (_town === global_json['features'][i].properties.RTOWN){
        village = global_json['features'][i].properties.scno;
        if (!inner_list.includes(village)){
            inner=inner+'<option value='+village+'>'+village+'</option>';
            inner_list.push(village);
        };
      };
    };
    village_list.innerHTML=inner;
  };

  function change_village(_village) {
    village = _village;
  }

  var button = document.querySelector("#find_land");
  button.addEventListener("click",
    function () {
      _selected = -1
      inputValue1 = document.getElementById("pmno").value;
      inputValue2 = document.getElementById("pcno").value;
      for (let i=0;i<global_json['features'].length;i++){
        if (village === global_json['features'][i].properties.scno){
          if (inputValue1 === global_json['features'][i].properties.pmno){
            if (inputValue2 === global_json['features'][i].properties.pcno){
              _selected = i
              break;
            };
          };
        };
      }
  if (_selected === -1) {
    window.alert("查無地號，請確認後重新查詢！");
    } else {
      const feature = global_json['features'][_selected];
      let coords = feature.geometry;
      // 支援點線面的中心點
      let center;
      if (coords.type === "Point") {
        center = {
          lat: coords.coordinates[1],
          lng: coords.coordinates[0]
        };
      } else {
        // 線或面 — 使用 Leaflet 來取得中心
        const layer = L.geoJSON(feature);
        center = layer.getBounds().getCenter();
      }
      map.flyTo(center, 18, { duration: 1.5 }); // 移動到該地點
      L.popup()
      .setLatLng(center)
      .setContent("地號：" + feature.properties.LANDNO)
      .openOn(map);
      }
    }
  )
  // 定義全域變數來儲存 GPS marker，避免重複疊加
let gpsMarker = null;

document.getElementById("get_gps").addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("此瀏覽器不支援 GPS 定位！");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // 清除舊的 GPS marker
      if (gpsMarker) {
        map.removeLayer(gpsMarker);
      }
      // 新增 GPS marker
      gpsMarker = L.marker([lat, lng]).addTo(map);

      // 將地圖移動到當前位置
      map.flyTo([lat, lng], 17); // 可調整 zoom
    },
    (error) => {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          alert("您拒絕了 GPS 存取。");
          break;
        case error.POSITION_UNAVAILABLE:
          alert("無法取得您目前的位置。");
          break;
        case error.TIMEOUT:
          alert("定位逾時，請再試一次。");
          break;
        default:
          alert("發生未知錯誤。");
      }
    }
  );
});

  </script>

</body>
</html>
