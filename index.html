<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>南水分署土地盤點系統</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css"/>
  <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
    }
    .form-container {
      width: 100%;
      border: 1px solid #ccc;
      padding: 1em;
      margin: 1em auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    /* 地圖 RWD */
    #container {
      height: 40vh; /* 40% 螢幕高度 */
      min-height: 250px;
      margin: 10px 0;
    }
    #map {
      height: 100%;
    }
    /* 手機 (長寬比小於 1 → 高 > 寬) */
    @media (max-aspect-ratio: 1/1) {
      #container {
        height: 20vh;   /* 改成佔 25% 高度 */
        min-height: 180px;
      }
    }
    /* 圖片區塊 RWD */
    .image-wrapper {
      width: 100%;
      max-width: 100%;
      aspect-ratio: 16/9;
      margin: 10px 0;
    }
    #preview-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }
    #preview-image.visible {
      display: block;
    }
    /* 小螢幕優化 */
    @media (max-width: 576px) {
      select, input, textarea, button {
        width: 100% !important;
      }
    }
    .form-preview-value {
      margin: 0.2em 0;
      white-space:pre-wrap;
    }
    .form-preview-value-people {
      white-space: pre-wrap;
      width: 100vw;
      position: relative;
      box-sizing: border-box;
    }
    .basemaps {
      padding: 4px;
    }
    .basemaps.closed .basemap {
      display: none;
    }
    .basemaps.closed .basemap.alt {
      display: inline-block;
    }
    .basemaps.closed .basemap.alt h4 {
      display: none;
    }
    .basemap {
      display: inline-block; /* todo: flexbox? */
      cursor: pointer;
    }
    .basemap.active img {
      border-color: orange;
      box-shadow: 2px 2px 4px #000;
    }
    .basemap img {
      width: 64px;
      border: 2px solid #FFF;
      margin: 0 2px;
      border-radius: 40px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.65)
    }
    #feature-info table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      margin-top: 10px;
    }
    #feature-info th,
    #feature-info td {
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      vertical-align: top;
    }
    #feature-info th {
      background-color: #f8f9fa;
      color: #343a40;
      text-align: left;
      width: 30%;
      font-weight: 600;
    }
    #feature-info td {
      text-align: right;
    }
    #feature-info tr:hover {
      background-color: #e9f5ff;
    }
    #google_map {
      background-color: #4285f4; /* Google 藍 */
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 1rem;
      font-weight: 500;
      border-radius: 4px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    #google_map:hover {
      background-color: #3367d6; /* 深一點的藍色 */
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(66, 133, 244, 0.4);
    }
    #google_map:active {
      background-color: #2a56c6;
    }
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .spinner {
      font-size: 20px;
      color: #333;
    }


  /* 清單項目標籤 */
  .leaflet-control-layers label {
    display: flex;
    align-items: center;
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  /* 滑鼠滑過項目改色 */
  .leaflet-control-layers label:hover {
    background-color: #f0f8ff;
  }
  /* checkbox 和 radio 按鈕調整大小 */
  .leaflet-control-layers input[type="checkbox"],
  .leaflet-control-layers input[type="radio"] {
    margin-right: 10px;
    transform: scale(1.2);
    cursor: pointer;
  }
  /* 圖層名稱字體顏色和大小 */
  .leaflet-control-layers label span {
    font-size: 14px;
    color: #333;
  }
  /* 捲軸美化（當圖層很多時） */
  .leaflet-control-layers-list {
    max-height: 250px;
    overflow-y: auto;
    padding-right: 4px;
  }
  .leaflet-control-layers-list::-webkit-scrollbar {
    width: 6px;
  }
  .leaflet-control-layers-list::-webkit-scrollbar-thumb {
    background-color: #4a90e2;
    border-radius: 3px;
  }
  </style>
</head>

<body>
<div class="container">
  <h1 class="text-center my-3">南水分署土地盤點系統</h1>
  <div class="form-container" id="form-content">
    <div class="row">
      <div id="loading-overlay">
        <div class="spinner">資料載入中，請稍候...</div>
      </div>
      <div class="col-md-4 col-12">
        <label for="county">縣市：</label>
        <select id="county_list" class="form-select" onchange="change_county(this.value)"></select>
      </div>
      <div class="col-md-4 col-12">
        <label for="town">行政區：</label>
        <select id="town_list" class="form-select" onchange="change_town(this.value)"></select>
      </div>
      <div class="col-md-4 col-12">
        <label for="dist">地段：</label>
        <select id="village_list" class="form-select" onchange="change_village(this.value)"></select>
      </div>
    </div>
    <div class="row mt-2">
      <div class="col-md-6 col-12">
        <input type="text" id="pmno" name="pmno" class="form-control" placeholder="母地號" />
      </div>
      <div class="col-md-6 col-12">
        <input type="text" id="pcno" name="pcno" class="form-control" placeholder="子地號" />
      </div>
    </div>
    <div class="row mt-2">
      <div class="col-12">
        <label for="people">盤點人員：</label>
        <input type="text" id="people" name="people" class="form-control" />
      </div>
    </div>
    <div class="mt-2">
      <button type="button" id="find_land" class="btn btn-primary w-100">確認盤點內容</button>
    </div>
    <div class="row mt-2">
      <div class="col-md-6 col-12">
        <label for="occupation">是否有佔用情形：</label>
        <select id="occupation_list" class="form-select">
          <option value="0">請選擇</option>
          <option value="1">是</option>
          <option value="2">否</option>
        </select>
      </div>
      <div class="col-md-6 col-12">
        <label for="break">是否有設施損壞、異常情形：</label>
        <select id="break_list" class="form-select">
          <option value="0">請選擇</option>
          <option value="1">是</option>
          <option value="2">否</option>
        </select>
      </div>
    </div>
    <div class="mt-2">
      <label for="message">備註：</label>
      <textarea id="message" name="message" rows="2" class="form-control"></textarea>
    </div>
    <div class="mt-2">
      <button type="button" id="get_gps" class="btn btn-secondary w-100">取得 GPS 位置</button>
    </div>
    <div id="container" class="mt-3">
      <div id="map">
        <div class="modal fade" id="featureModal" tabindex="-1" role="dialog">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title text-primary" id="feature-title"></h4>
                <button class="close" type="button" data-bs-dismiss="modal">×</button>
              </div>
              <div class="modal-body" id="feature-info"></div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" id="google_map">在Google地圖開啟</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-3" id="image_top">
      <label for="image">上傳圖片：</label>
      <input type="file" id="image" class="form-control" accept="image/*" />
    </div>

    <div class="image-wrapper">
      <img id="preview-image" src="" alt="圖片預覽" />
    </div>
  </div>
  <div class="text-center my-4">
    <button class="btn btn-success" onclick="generatePDF()">匯出為 PDF</button>
  </div>
</div>

<script>
  var map = L.map('map', {center: [22.689,120.436], zoom: 15, zoomControl: true, renderer: L.canvas()});
  L.control.scale({position: 'bottomleft'}).addTo(map);
  var basemaps = [
    L.tileLayer('https://wmts.nlsc.gov.tw/wmts/{id}/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
    maxZoom: 20,
    id: 'EMAP',
    label: '測試一' }),
    L.tileLayer('https://wmts.nlsc.gov.tw/wmts/{id}/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
    maxZoom: 20,
    id: 'PHOTO2',
    label: '測試二' }),
    L.tileLayer('https://wmts.nlsc.gov.tw/wmts/{id}/default/GoogleMapsCompatible/{z}/{y}/{x}.png', {
      maxZoom: 20,
      id: 'LUIMAP',
      label: '測試三' })
  ];
  L.Control.Basemaps=L.Control.extend({_map:null,includes:L.Evented?L.Evented.prototype:L.Mixin.Event,options:{position:"bottomright",tileX:0,tileY:0,tileZ:0,layers:[]},basemap:null,onAdd:function(e){this._map=e;var t=L.DomUtil.create("div","basemaps leaflet-control closed");return L.DomEvent.disableClickPropagation(t),L.Browser.touch||L.DomEvent.disableScrollPropagation(t),this.options.basemaps.forEach(function(s,o){var a,i="basemap";if(0===o?(this.basemap=s,this._map.addLayer(s),i+=" active"):1===o&&(i+=" alt"),s.options.iconURL)a=s.options.iconURL;else{var l={x:this.options.tileX,y:this.options.tileY};if(a=L.Util.template(s._url,L.extend({s:s._getSubdomain(l),x:l.x,y:s.options.tms?s._globalTileRange.max.y-l.y:l.y,z:this.options.tileZ},s.options)),s instanceof L.TileLayer.WMS){s._map=e;var n=s.options.crs||e.options.crs,r=L.extend({},s.wmsParams),m=parseFloat(r.version);r[m>=1.3?"crs":"srs"]=n.code;var p=L.point(l);p.z=this.options.tileZ;var c=s._tileCoordsToBounds(p),d=n.project(c.getNorthWest()),h=n.project(c.getSouthEast()),v=(m>=1.3&&n===L.CRS.EPSG4326?[h.y,d.x,d.y,h.x]:[d.x,h.y,h.x,d.y]).join(",");a+=L.Util.getParamString(r,a,s.options.uppercase)+(s.options.uppercase?"&BBOX=":"&bbox=")+v}}var b=L.DomUtil.create("div",i,t),u=L.DomUtil.create("img",null,b);u.src=a,s.options&&s.options.label&&(u.title=s.options.label),L.DomEvent.on(b,"click",function(){if(this.options.basemaps.length>2&&L.Browser.mobile&&L.DomUtil.hasClass(t,"closed"))L.DomUtil.removeClass(t,"closed");else if(s!=this.basemap){e.removeLayer(this.basemap),e.addLayer(s),s.bringToBack(),e.fire("baselayerchange",s),this.basemap=s,L.DomUtil.removeClass(t.getElementsByClassName("basemap active")[0],"active"),L.DomUtil.addClass(b,"active");var a=(o+1)%this.options.basemaps.length;L.DomUtil.removeClass(t.getElementsByClassName("basemap alt")[0],"alt"),L.DomUtil.addClass(t.getElementsByClassName("basemap")[a],"alt"),L.DomUtil.addClass(t,"closed")}},this)},this),this.options.basemaps.length>2&&!L.Browser.mobile&&(L.DomEvent.on(t,"mouseenter",function(){L.DomUtil.removeClass(t,"closed")},this),L.DomEvent.on(t,"mouseleave",function(){L.DomUtil.addClass(t,"closed")},this)),this._container=t,this._container}}),L.control.basemaps=function(e){return new L.Control.Basemaps(e)};
  map.addControl(L.control.basemaps({
    basemaps: basemaps,
    tileX: 854,
    tileY: 444,
    tileZ: 10
  }));
  const imageInput = document.getElementById('image');
  const previewImage = document.getElementById('preview-image');
  imageInput.addEventListener('change', function () {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        previewImage.src = e.target.result;
        previewImage.classList.add('visible');
      };
      reader.readAsDataURL(file);
    } else {
      previewImage.src = '';
      previewImage.classList.remove('visible');
    }
  });

  async function generatePDF() {
    const original = document.getElementById('form-content');
    const clone = original.cloneNode(true);
    // 取得現在時間字串
    const now = new Date();
    const formattedTime = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} `;
    // 建立時間段落
    const timeP = document.createElement('p');
    timeP.textContent = `盤點日期：${formattedTime}`;
    clone.insertBefore(timeP, clone.firstChild); // 插入到 clone 的最前面
    // 移除 clone 中的「確認盤點內容」按鈕
    const findLandBtn = clone.querySelector('#find_land');
    if (findLandBtn) {
      findLandBtn.remove();
    }
    // 移除 get_gps 按鈕
    const gpsBtn = clone.querySelector("#get_gps");
    if (gpsBtn) {
      gpsBtn.remove();
    }
    // 移除圖片路徑
    const img_path = clone.querySelector("#image_top");
    if (img_path) {
      img_path.remove();
    }
    // 從原始 map 元素截圖，不要用 clone 裡的
    const mapElementOriginal = document.querySelector('#map');
    const mapElementClone = clone.querySelector('#map');
    if (mapElementOriginal && mapElementClone) {
      try {
        const canvas = await html2canvas(mapElementOriginal, {
          useCORS: true,
          scale: 2,
          scrollX: 0,
          scrollY: -window.scrollY,
          windowWidth: document.documentElement.clientWidth,
          windowHeight: document.documentElement.clientHeight,
        });
        const imgDataUrl = canvas.toDataURL('image/png');
        const img = document.createElement('img');
        img.src = imgDataUrl;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'fill';
        mapElementClone.parentNode.replaceChild(img, mapElementClone);
      } catch (error) {
        console.error('地圖截圖失敗:', error);
      }
    }

    // 把原始頁面上的所有輸入欄位轉成純文字段落（保留選取值）
    const originalElements = Array.from(original.querySelectorAll('textarea, select'));
    const cloneElements = Array.from(clone.querySelectorAll('textarea, select'));
    cloneElements.forEach(cloneEl => {
      const name = cloneEl.getAttribute('name') || cloneEl.getAttribute('id');
      const originalEl = originalElements.find(el =>
        (el.getAttribute('name') || el.getAttribute('id')) === name
      );
      if (!originalEl) return;
      const label = cloneEl.previousElementSibling;
      const labelText = label ? label.textContent.trim() : '';
      const p = document.createElement('p');
      let valueText = '';
      if (originalEl.tagName.toLowerCase() === 'select') {
        valueText = originalEl.options[originalEl.selectedIndex]?.text || '';
      } else {
        valueText = originalEl.value;
      }
      p.textContent = `${labelText} ${valueText}`;
      p.classList.add('form-preview-value');
      if (label) label.remove();
      cloneEl.replaceWith(p);
    });

    const inputIds = ['pmno', 'pcno', 'people'];
    const labelsMap = {
      pmno: '地號：',
      pcno: '-',
      people: '                                                  盤點人員：'
    };
    const cloneContainer = clone;  // 你的複製容器
    clone.style.border = 'none';
    const firstCloneInput = clone.querySelector(`#${inputIds[0]}`);  // 找到第一個 input
    if (!firstCloneInput) {
      console.error(`找不到 id=${inputIds[0]} 的 input`);
      return;
    }
    let combinedText = '';
    inputIds.forEach(id => {
      const originalInput = original.querySelector(`#${id}`);
      const cloneInput = clone.querySelector(`#${id}`);
      if (!originalInput || !cloneInput) return;
      combinedText += `${labelsMap[id] || ''}${originalInput.value} `;
      if (cloneInput.closest('label')) { // 移除相關 label（先移除，input 稍後處理）
        cloneInput.closest('label').remove();
      } else {
        const label = clone.querySelector(`label[for="${id}"]`);
        if (label) label.remove();
      }
      if (id !== inputIds[0]) { // 除了第一個 input，其他 input 先移除
        cloneInput.remove();
      }
    });
    const p = document.createElement('p');// 建立 <p>
    p.classList.add('form-preview-value', 'form-preview-value-people');
    p.textContent = combinedText.trim();
    firstCloneInput.replaceWith(p); // 用 <p> 替換第一個 input
    const imgPreview = clone.querySelector('#preview-image'); // 圖片處理 (form中的預覽圖片)
    if (imgPreview) {
      if (!imgPreview.src) {
        imgPreview.remove();
      } else {
        imgPreview.style.width = '100%';
        imgPreview.style.height = '100%';
        imgPreview.style.objectFit = 'fill';
        imgPreview.classList.add('visible');
      }
    }
    clone.querySelectorAll('p, div').forEach(el => { // 移除空白節點，避免多餘空白
      if (!el.textContent.trim() && el.querySelectorAll('*').length === 0) {
        el.remove();
      }
    });
    const waitForImage = new Promise(resolve => { // 等圖片載入完成後匯出 PDF
      if (!imgPreview || (imgPreview.complete && imgPreview.naturalHeight !== 0)) {
        resolve();
      } else {
        imgPreview.onload = () => resolve();
        imgPreview.onerror = () => resolve();
      }
    });
    await waitForImage;
    const opt = {
      margin: 10,
      filename: county + town + village + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        scrollY: 0,
      },
      jsPDF: {
        unit: 'mm',
        format: 'a4',
        orientation: 'portrait',
      },
    };
    html2pdf().set(opt).from(clone).toPdf().get('pdf').then(function (pdf) {
      const totalPages = pdf.internal.getNumberOfPages();
      if (totalPages > 1) {
        pdf.deletePage(2); // 刪掉第2頁
      }
      pdf.save(opt.filename);
    });
  }

  google_map_url = 'https://www.google.com/maps/search/?api=1&query='
  async function loadAllData() {
    document.getElementById('loading-overlay').style.display = 'flex';
    try {
      const res1 = await fetch("https://joe123890508.github.io/wrasb_land.github.io/compared.json");
      global_json2 = await res1.json();
      const res2 = await fetch("https://joe123890508.github.io/wrasb_land.github.io/114wrasb_web2.geojson");
      global_json = await res2.json();
      processGeoJson(global_json, global_json2);
    } catch (error) {
      console.error("資料載入失敗", error);
      alert("資料載入失敗，請稍後再試！");
    } finally {
      document.getElementById('loading-overlay').style.display = 'none';
    }
  }
  function processGeoJson(json, compareData) {
    json.features.forEach(feature => {
        let id1 = feature.properties.區域;
        feature.properties.區域 = compareData[id1] || "未知";
        let id2 = feature.properties.單位;
        feature.properties.單位 = compareData[id2] || "未知";
      });
      let data=json.features;
      let layersByCategory = {}; // 儲存分類圖層
      function getColorByCategory(category) {
        const colorMap = {
          "牡管中心": "green",
          "高管中心": "blue",
          "秘書室": "darkmagenta",
          "資產科": "goldenrod",
          "阿管中心": "limegreen",
          "工務科": "darkcyan",
          "曾管中心": "tomato",
          "甲管中心": "coral",
          "未知": "gray",
        };
        return colorMap[category] || "black";
      }
  const controlLayers = L.control.layers(null, null, {collapsed: true}).addTo(map);
  data.forEach(feature => {
    let category = feature.properties.單位;
    if (!layersByCategory[category]) {
      layersByCategory[category] = L.geoJSON(null, {
        style: function (f) {
          return {
            weight: 1.35,
            color: getColorByCategory(category)
          };
        },
        //renderer: L.canvas(),
        onEachFeature:  function (feature, layer) {
              layer.on("click", () => {
              table_content = '<table border="1">'
              for (let key in feature.properties) {
                table_content = table_content + '<tr><th>' + key + '</th><td>' + feature.properties[key] + '</td></tr>'
              };
              table_content = table_content + '</table>'
              document.getElementById("feature-info").innerHTML = table_content
              document.getElementById("feature-title").innerHTML = feature.properties['scno'] + feature.properties['LANDNO']
              $('#featureModal').modal('show')
              const center = layer.getBounds().getCenter()
              const lat = center.lat
              const lng = center.lng
              url = google_map_url + lat + ',' +lng
              $('#google_map').off().on('click', function () {
                window.open(url);
              });
              $('.close').click(function() {
                $('#featureModal').modal('hide');
              });
              });
        }
      });
      let color = getColorByCategory(category); // 為這個圖層分類建立一個帶色塊的小圖示名稱
      let nameWithIcon = `
        <span style="
          display:inline-block;
          width:12px; height:12px;
          background:${color};
          margin-right:6px;
          border-radius:3px;
        "></span>${category}`;
      controlLayers.addOverlay(layersByCategory[category], nameWithIcon);
    }
    layersByCategory[category].addData(feature);
  });
  for (let category in layersByCategory) {
    map.addLayer(layersByCategory[category]);
  }
    var county_list=document.getElementById("county_list");
    town_list.innerHTML="<option value>請選擇鄉鎮</option>";
    village_list.innerHTML="<option value>請選擇地段</option>";
    global_json = json
    let inner="<option value>請選擇縣市</option>";
    let inner_list = [];
    for (let i=0;i<json['features'].length;i++){
      let county = json['features'][i].properties.RCOUNTY;
      if (!inner_list.includes(county)){
        inner=inner+'<option value='+county+'>'+county+'</option>';
        inner_list.push(county);
      }
    };
    county_list.innerHTML=inner;
  }
  loadAllData();
  L.control.fullscreen({
    position: 'topleft',
    forceSeparateButton: true,
    forcePseudoFullscreen: true,
    fullscreenElement: false
  }).addTo(map);

  function change_county(_county) {
    county = _county
    village_list.innerHTML="<option value>請選擇地段</option>";
    var inner="<option value>請選擇鄉鎮</option>";
    let inner_list = []
    for (let i=0;i<global_json['features'].length;i++){
      if (_county === global_json['features'][i].properties.RCOUNTY){
        let town = global_json['features'][i].properties.RTOWN;
        if (!inner_list.includes(town)){
            inner=inner+'<option value='+town+'>'+town+'</option>';
            inner_list.push(town);
        };
      };
    };
    town_list.innerHTML=inner;
  };
  function change_town(_town) {
    town = _town
    var inner="<option value>請選擇地段</option>";
    let inner_list = []
    for (let i=0;i<global_json['features'].length;i++){
      if (_town === global_json['features'][i].properties.RTOWN){
        let village = global_json['features'][i].properties.scno;
        if (!inner_list.includes(village)){
            inner=inner+'<option value='+village+'>'+village+'</option>';
            inner_list.push(village);
        };
      };
    };
    village_list.innerHTML=inner;
  };
  function change_village(_village) {
    village = _village;
  }

  var button = document.querySelector("#find_land");
  button.addEventListener("click",
    function () {
      _selected = -1
      inputValue1 = document.getElementById("pmno").value;
      inputValue2 = document.getElementById("pcno").value;
      for (let i=0;i<global_json['features'].length;i++){
        if (village === global_json['features'][i].properties.scno){
          if (inputValue1 === global_json['features'][i].properties.pmno){
            if (inputValue2 === global_json['features'][i].properties.pcno){
              _selected = i
              break;
            };
          };
        };
      }
  if (_selected === -1) {
    window.alert("查無地號，請確認後重新查詢！");
    } else {
      const feature = global_json['features'][_selected];
      let coords = feature.geometry;
      let center; // 支援點線面的中心點
      if (coords.type === "Point") {
        center = {
          lat: coords.coordinates[1],
          lng: coords.coordinates[0]
        };
      } else {
        const layer = L.geoJSON(feature); // 線或面 — 使用 Leaflet 來取得中心
        center = layer.getBounds().getCenter();
      }
      map.flyTo(center, 18, { duration: 1.5 }); // 移動到該地點
      L.popup()
      .setLatLng(center)
      .setContent("地號：" + feature.properties.LANDNO)
      .openOn(map);
      }
    }
  )
  let gpsMarker = null; // 定義全域變數來儲存 GPS marker，避免重複疊加
  document.getElementById("get_gps").addEventListener("click", () => {
    if (!navigator.geolocation) {
      alert("此瀏覽器不支援 GPS 定位！");
      return;
    }
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      if (gpsMarker) {
        map.removeLayer(gpsMarker); // 清除舊的 GPS marker
      }
      gpsMarker = L.marker([lat, lng]).addTo(map); // 新增 GPS marker
      map.flyTo([lat, lng], 17); // 將地圖移動到當前位置(可調整 zoom)
    },
    (error) => {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          alert("您拒絕了 GPS 存取。");
          break;
        case error.POSITION_UNAVAILABLE:
          alert("無法取得您目前的位置。");
          break;
        case error.TIMEOUT:
          alert("定位逾時，請再試一次。");
          break;
        default:
          alert("發生未知錯誤。");
      }
    }
  );
});
  </script>
</body>
</html>